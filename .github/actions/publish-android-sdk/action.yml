name: 'Publish Android SDK'
description: 'Build and publish Android SDK packages to Maven Central'

inputs:
    workspace-path:
        description: 'Path to the Android SDK workspace'
        required: true
        default: 'sdk/@launchdarkly/observability-android'
    java_version:
        description: 'The Java version to use.'
        required: false
        default: '17'
    java_distribution:
        description: 'The Java distribution to use.'
        required: false
        default: 'temurin'
    aws-role-arn:
        description: 'AWS role ARN for accessing secrets'
        required: true
    dry-run:
        description: 'Whether to run the publish in dry-run mode'
        required: false
        default: 'false'
    prerelease:
        description: 'Whether to publish a prerelease version'
        required: false
        default: 'false'

runs:
    using: 'composite'
    steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Java
          uses: actions/setup-java@v4
          with:
            distribution: ${{ inputs.java_distribution }}
            java-version: ${{ inputs.java_version }}

        - name: Setup Android SDK
          uses: android-actions/setup-android@v3

        - uses: launchdarkly/gh-actions/actions/release-secrets@release-secrets-v1.1.0
          name: Get secrets
          with:
            aws_assume_role: ${{ inputs.aws-role-arn }}
            ssm_parameter_pairs: '/production/common/releasing/sonatype/central/username = SONATYPE_USER_NAME,
            /production/common/releasing/sonatype/central/password = SONATYPE_PASSWORD,
            /production/common/releasing/android_code_signing/private_key_id = SIGNING_KEY_ID,
            /production/common/releasing/android_code_signing/private_key_passphrase = SIGNING_KEY_PASSPHRASE'
            s3_path_pairs: 'launchdarkly-releaser/android/code-signing-keyring.gpg = code-signing-keyring.gpg'

        - name: Publish Library
          shell: bash
          if: ${{ inputs.dry-run != 'true' }}
          working-directory: ${{ inputs.workspace-path }}
          env:
            LD_RELEASE_IS_PRERELEASE: ${{ inputs.prerelease }}
            SIGNING_KEY_ID: ${{ env.SIGNING_KEY_ID }}
            SIGNING_KEY_PASSPHRASE: ${{ env.SIGNING_KEY_PASSPHRASE }}
            SIGNING_SECRET_KEY_RING_FILE: ${{ github.workspace }}/code-signing-keyring.gpg
            SONATYPE_USER_NAME: ${{ env.SONATYPE_USER_NAME }}
            SONATYPE_PASSWORD: ${{ env.SONATYPE_PASSWORD }}
          run: source $GITHUB_ACTION_PATH/publish.sh

        - name: Dry Run Publish Library
          shell: bash
          if: ${{ inputs.dry-run == 'true' }}
          run: echo "Dry run. Not publishing."
